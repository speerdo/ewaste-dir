---
import type { RecyclingCenter } from '../types/supabase';

interface Props {
  cityName: string;
  state: string;
  centers: RecyclingCenter[];
  localData?: {
    regulations?: any;
    stats?: any;
  };
  showNearbyMessage?: boolean;
}

const { cityName, state, centers, localData, showNearbyMessage } = Astro.props;

// Helper functions for dynamic content generation
function getTopRatedCenter(centers: RecyclingCenter[]) {
  return centers
    .filter(c => c.rating && Number(c.rating) > 0)
    .sort((a, b) => Number(b.rating) - Number(a.rating))[0];
}

function getCityGovernmentCenter(centers: RecyclingCenter[]) {
  return centers.find(c => 
    c.name.toLowerCase().includes('city') || 
    c.name.toLowerCase().includes('municipal') ||
    c.name.toLowerCase().includes('public works') ||
    c.name.toLowerCase().includes('government')
  );
}

function getChainCenters(centers: RecyclingCenter[]) {
  const chains = ['best buy', 'staples', 'goodwill', 'waste management', 'republic services'];
  return centers.filter(c => 
    chains.some(chain => c.name.toLowerCase().includes(chain))
  );
}

function getBusinessTypes(centers: RecyclingCenter[]) {
  const types = new Map();
  centers.forEach(center => {
    const name = center.name.toLowerCase();
    const desc = (center.description || '').toLowerCase();
    const text = `${name} ${desc}`;
    
    if (text.includes('electronics') || text.includes('computer')) types.set('electronics', (types.get('electronics') || 0) + 1);
    if (text.includes('metal') || text.includes('scrap')) types.set('metal', (types.get('metal') || 0) + 1);
    if (text.includes('repair') || text.includes('service')) types.set('repair', (types.get('repair') || 0) + 1);
    if (text.includes('auto') || text.includes('battery')) types.set('automotive', (types.get('automotive') || 0) + 1);
  });
  return types;
}

function generateUniqueFAQs(cityName: string, state: string, centers: RecyclingCenter[], localData?: any) {
  const faqs = [];
  const centerCount = centers.length;
  const topCenter = getTopRatedCenter(centers);
  const cityCenter = getCityGovernmentCenter(centers);
  const hasRegulations = localData?.regulations;
  
  // Always include a city-specific question about availability
  if (centerCount === 1) {
    faqs.push({
      question: `Is there electronics recycling available in ${cityName}?`,
      answer: `Yes, ${cityName} has ${centerCount} electronics recycling center. ${centers[0].name} accepts computers, phones, TVs and other electronic devices. It's located at ${centers[0].full_address}. Contact them at ${centers[0].phone || 'their listed number'} to confirm what items they accept and their current hours.`
    });
  } else {
    faqs.push({
      question: `How many electronics recycling centers are in ${cityName}?`,
      answer: `${cityName} has ${centerCount} electronics recycling centers. These facilities accept computers, phones, TVs, and other electronic devices. ${topCenter ? `${topCenter.name} is one of the highest-rated options with a ${topCenter.rating}-star rating.` : ''} Each center may have different accepted items and fees, so it's recommended to call ahead.`
    });
  }

  // Add city government question if applicable
  if (cityCenter) {
    faqs.push({
      question: `Does ${cityName} have a city-run recycling program?`,
      answer: `Yes, ${cityCenter.name} provides electronics recycling services for ${cityName} residents. City-operated facilities often offer free drop-off for residents and may have special programs for bulk electronics or business disposal. Contact them directly for specific policies and accepted items.`
    });
  }

  // Add state-specific regulations question
  if (hasRegulations && hasRegulations.has_ewaste_ban) {
    faqs.push({
      question: `What are the electronics disposal laws in ${cityName}, ${state}?`,
      answer: `${state} prohibits disposal of electronics in regular trash. ${hasRegulations.landfill_restrictions || `All computers, TVs, phones and other electronics must be recycled through authorized facilities in ${cityName}.`} ${hasRegulations.penalties_fines ? `Violations can result in fines, so it's important to use certified recyclers.` : ''}`
    });
  } else {
    faqs.push({
      question: `Are there any electronics disposal restrictions in ${cityName}?`,
      answer: `While ${state} may not have statewide electronics disposal bans, many ${cityName} facilities encourage responsible recycling. Electronics contain valuable materials and hazardous substances that should be properly processed. Check with your chosen recycling center about their environmental certifications and data destruction services.`
    });
  }

  // Add practical question about preparation
  faqs.push({
    question: `How should I prepare electronics for recycling in ${cityName}?`,
    answer: `Before recycling electronics in ${cityName}, remove all personal data by backing up files and performing a factory reset. Remove batteries when possible and keep cables with their devices. ${topCenter ? `${topCenter.name}` : 'Most centers'} can provide guidance on data destruction services if you're concerned about sensitive information.`
  });

  return faqs.slice(0, 4); // Limit to 4 FAQs to keep content manageable
}

// Generate dynamic content based on available data
const topRatedCenter = getTopRatedCenter(centers);
const cityGovCenter = getCityGovernmentCenter(centers);
const chainCenters = getChainCenters(centers);
const businessTypes = getBusinessTypes(centers);
const verifiedCenters = centers.filter(c => c.is_legitimate === true);
const uniqueFAQs = generateUniqueFAQs(cityName, state, centers, localData);

// Generate city-specific insights
const cityInsights = [];
if (centers.length > 10) {
  cityInsights.push(`${cityName} has an extensive network of ${centers.length} electronics recycling facilities, making it easy for residents to find convenient drop-off locations.`);
}
if (topRatedCenter) {
  cityInsights.push(`${topRatedCenter.name} stands out with a ${topRatedCenter.rating}-star rating from local customers.`);
}
if (cityGovCenter) {
  cityInsights.push(`The city operates ${cityGovCenter.name}, providing residents with a municipal recycling option.`);
}
if (chainCenters.length > 0) {
  cityInsights.push(`National retailers like ${chainCenters.slice(0, 2).map(c => c.name.split(' ')[0]).join(' and ')} offer convenient drop-off locations.`);
}
if (verifiedCenters.length > centers.length * 0.7) {
  cityInsights.push(`Most facilities in ${cityName} have been verified for legitimate electronics recycling operations.`);
}
---

<!-- Unique City Overview Section -->
<div class="bg-gradient-to-r from-blue-50 to-green-50 border border-gray-200 rounded-lg p-6 mb-8">
  <h2 class="text-2xl font-semibold text-gray-900 mb-4">
    Electronics Recycling Guide for {cityName}
  </h2>
  
  <div class="prose prose-lg max-w-none">
    <p class="text-gray-700 leading-relaxed mb-4">
      {showNearbyMessage 
        ? `While ${cityName} has limited electronics recycling options, residents can access ${centers.length} nearby facilities in the ${state} area. These certified recyclers provide safe disposal services for computers, phones, televisions, and other electronic devices.`
        : `${cityName}, ${state} offers ${centers.length} ${centers.length === 1 ? 'electronics recycling center' : 'electronics recycling centers'} to serve local residents and businesses. These facilities provide safe, environmentally responsible disposal of computers, phones, televisions, and other electronic devices.`
      }
    </p>
    
    {cityInsights.length > 0 && (
      <div class="bg-white p-4 rounded-lg border-l-4 border-blue-500 mb-4">
        <h3 class="font-semibold text-blue-800 mb-2">Key Highlights</h3>
        <ul class="text-sm text-blue-700 space-y-1">
          {cityInsights.map(insight => (
            <li>â€¢ {insight}</li>
          ))}
        </ul>
      </div>
    )}
  </div>
</div>

<!-- Business Types Analysis (if diverse) -->
{businessTypes.size > 1 && (
  <div class="bg-white border border-gray-200 rounded-lg p-6 mb-8">
    <h3 class="text-xl font-semibold text-gray-900 mb-4">Types of Recycling Services in {cityName}</h3>
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
      {Array.from(businessTypes.entries()).map(([type, count]) => (
        <div class="text-center p-3 bg-gray-50 rounded-lg">
          <div class="text-2xl font-bold text-blue-600">{count}</div>
          <div class="text-sm text-gray-600 capitalize">{type} Centers</div>
        </div>
      ))}
    </div>
    <p class="text-sm text-gray-600 mt-4">
      {cityName} offers diverse recycling services, from specialized electronics processors to comprehensive waste management facilities. 
      Each center may have different specialties, accepted items, and fee structures.
    </p>
  </div>
)}

<!-- Unique FAQ Section -->
<div class="bg-white border border-gray-200 rounded-lg p-6 mb-8">
  <h3 class="text-xl font-semibold text-gray-900 mb-6">Frequently Asked Questions - {cityName} Electronics Recycling</h3>
  <div class="space-y-6">
    {uniqueFAQs.map((faq, index) => (
      <div class="border-l-4 border-green-500 pl-4">
        <h4 class="font-semibold text-gray-800 mb-2">{faq.question}</h4>
        <p class="text-gray-700 text-sm leading-relaxed">{faq.answer}</p>
      </div>
    ))}
  </div>
</div>

<!-- Local Context Section -->
{(localData?.stats?.population || cityGovCenter) && (
  <div class="bg-green-50 border border-green-100 rounded-lg p-6 mb-8">
    <h3 class="text-xl font-semibold text-green-900 mb-4">{cityName} Community Impact</h3>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      {localData?.stats?.population && (
        <div>
          <h4 class="font-semibold text-green-800 mb-2">Community Scale</h4>
          <p class="text-sm text-green-700">
            With a population of {localData.stats.population.toLocaleString()}, {cityName} generates an estimated {Math.round(localData.stats.population * 45).toLocaleString()} pounds of electronic waste annually. 
            Proper recycling helps recover valuable materials and prevents environmental contamination.
          </p>
        </div>
      )}
      
      <div>
        <h4 class="font-semibold text-green-800 mb-2">Why Recycle in {cityName}?</h4>
        <ul class="text-sm text-green-700 space-y-1">
          <li>â€¢ Recover precious metals like gold, silver, and copper</li>
          <li>â€¢ Prevent toxic materials from entering local landfills</li>
          <li>â€¢ Support local jobs in the recycling industry</li>
          <li>â€¢ Comply with {state} environmental regulations</li>
        </ul>
      </div>
    </div>
  </div>
)}

<!-- What Makes Each Center Different -->
{centers.length > 1 && (
  <div class="bg-gray-50 border border-gray-200 rounded-lg p-6 mb-8">
    <h3 class="text-xl font-semibold text-gray-900 mb-4">Choosing the Right Recycler in {cityName}</h3>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div>
        <h4 class="font-semibold text-gray-800 mb-2">What to Consider</h4>
        <ul class="text-sm text-gray-700 space-y-2">
          <li>â€¢ Accepted items and any fees for specific electronics</li>
          <li>â€¢ Data destruction services and certificates</li>
          <li>â€¢ Operating hours and appointment requirements</li>
          <li>â€¢ Environmental certifications (R2, e-Stewards)</li>
          <li>â€¢ Customer reviews and business reputation</li>
        </ul>
      </div>
      
      <div>
        <h4 class="font-semibold text-gray-800 mb-2">Tips for {cityName} Residents</h4>
        <ul class="text-sm text-gray-700 space-y-2">
          <li>â€¢ Call ahead to confirm accepted items and hours</li>
          <li>â€¢ Remove personal data before drop-off</li>
          <li>â€¢ Ask about bulk pickup services for large quantities</li>
          <li>â€¢ Keep receipts for tax-deductible donations</li>
          <li>â€¢ Consider certified data destruction for sensitive devices</li>
        </ul>
      </div>
    </div>
  </div>
)} 

---
export interface Marker {
  lat: number;
  lng: number;
  name: string;
  address?: string;
  phone?: string;
  website?: string;
  id: string;
}

export interface Props {
  markers: Marker[];
  initialZoom?: number;
}

const { markers, initialZoom = 12 } = Astro.props;
---

<div class="relative w-full h-full rounded-lg overflow-hidden">
  <!-- Reset Map Button -->
  <button
    id="resetMap"
    class="absolute top-4 right-4 bg-white rounded-lg shadow-md px-4 py-2 z-[1000] flex items-center gap-2 text-gray-700 hover:bg-gray-50 transition-colors"
    style="display: none;"
  >
    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
    </svg>
    Reset Map
  </button>

  <div id="map" class="w-full h-full" role="application" aria-label="Interactive map showing recycling center locations">
    <!-- Loading state -->
    <div id="mapLoading" class="absolute inset-0 flex items-center justify-center bg-gray-100">
      <div class="text-gray-500" role="status" aria-live="polite">Loading map...</div>
    </div>
  </div>

  <!-- Error state (hidden by default) -->
  <div id="mapError" class="absolute inset-0 flex items-center justify-center bg-gray-100 hidden" role="alert">
    <div class="text-center p-4">
      <p class="text-red-500 mb-2">Failed to load map</p>
      <p class="text-gray-500 text-sm">Please try refreshing the page</p>
    </div>
  </div>
</div>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

<style>
  /* Custom styles for Leaflet popups to match previous design */
  :global(.leaflet-popup-content-wrapper) {
    padding: 0 !important;
    border-radius: 8px !important;
    box-shadow: 0 3px 14px rgba(0, 0, 0, 0.2) !important;
  }

  :global(.leaflet-popup-content) {
    margin: 0 !important;
    min-width: 200px !important;
  }

  :global(.leaflet-popup-close-button) {
    width: 28px !important;
    height: 28px !important;
    font-size: 20px !important;
    padding: 4px !important;
    color: #666 !important;
    top: 4px !important;
    right: 4px !important;
  }

  :global(.leaflet-popup-close-button:hover) {
    color: #333 !important;
  }

  /* Custom marker styles */
  :global(.leaflet-marker-icon) {
    transition: transform 0.1s ease-out;
  }

  :global(.marker-bounce) {
    animation: bounce 0.5s ease-in-out 3;
  }

  @keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
  }

  /* Remove focus outlines from popup links */
  :global(.leaflet-popup-content a),
  :global(.leaflet-popup-content button),
  :global(.map-link) {
    outline: none !important;
    box-shadow: none !important;
    border: none !important;
    text-decoration: none !important;
    -webkit-tap-highlight-color: transparent !important;
  }
</style>

<script define:vars={{ markers, initialZoom }}>
  // Store map state globally
  let map = null;
  let activeMarker = null;
  const markerRefs = new Map();
  let initialBounds = null;
  let initialCenter = null;
  let initialZoomLevel = null;

  // Global directions function
  window.openDirections = function(lat, lng) {
    if (!lat || !lng) return;
    window.open('https://www.google.com/maps/dir/?api=1&destination=' + lat + ',' + lng, '_blank');
  };
  window.showDirections = window.openDirections;

  function handleMapError(error) {
    console.error('Map error:', error);
    const mapElement = document.getElementById('map');
    const errorElement = document.getElementById('mapError');
    const loadingElement = document.getElementById('mapLoading');
    if (loadingElement) loadingElement.style.display = 'none';
    if (mapElement && errorElement) {
      mapElement.style.display = 'none';
      errorElement.classList.remove('hidden');
    }
  }

  // Load Leaflet script dynamically
  function loadLeaflet() {
    return new Promise((resolve, reject) => {
      // Check if already loaded
      if (window.L) {
        resolve(window.L);
        return;
      }

      const script = document.createElement('script');
      script.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
      script.integrity = 'sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=';
      script.crossOrigin = '';
      script.onload = () => resolve(window.L);
      script.onerror = () => reject(new Error('Failed to load Leaflet'));
      document.head.appendChild(script);
    });
  }

  // Initialize the map with markers
  async function initializeMap() {
    try {
      const mapElement = document.getElementById('map');
      const resetButton = document.getElementById('resetMap');
      const loadingElement = document.getElementById('mapLoading');

      if (!mapElement) {
        throw new Error('Map element not found');
      }

      // Load Leaflet
      const L = await loadLeaflet();

      // Hide loading state
      if (loadingElement) loadingElement.style.display = 'none';

      // Calculate initial center from markers
      const validMarkers = markers.filter(m => m.lat && m.lng && !isNaN(Number(m.lat)) && !isNaN(Number(m.lng)));

      if (validMarkers.length === 0) {
        throw new Error('No valid markers to display');
      }

      const centerLat = validMarkers.reduce((sum, m) => sum + Number(m.lat), 0) / validMarkers.length;
      const centerLng = validMarkers.reduce((sum, m) => sum + Number(m.lng), 0) / validMarkers.length;

      // Initialize map
      map = L.map(mapElement, {
        center: [centerLat, centerLng],
        zoom: initialZoom,
        scrollWheelZoom: true
      });

      // Add OpenStreetMap tiles
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(map);

      // Create bounds for fitting
      const bounds = L.latLngBounds();

      // Add markers
      validMarkers.forEach((marker) => {
        const position = [Number(marker.lat), Number(marker.lng)];
        bounds.extend(position);

        // Create custom icon
        const icon = L.divIcon({
          className: 'custom-marker',
          html: `<svg width="25" height="41" viewBox="0 0 25 41" xmlns="http://www.w3.org/2000/svg">
            <path d="M12.5 0C5.6 0 0 5.6 0 12.5c0 9.4 12.5 28.5 12.5 28.5S25 21.9 25 12.5C25 5.6 19.4 0 12.5 0z" fill="#22c55e" stroke="#166534" stroke-width="1"/>
            <circle cx="12.5" cy="12.5" r="5" fill="white"/>
          </svg>`,
          iconSize: [25, 41],
          iconAnchor: [12, 41],
          popupAnchor: [0, -35]
        });

        const leafletMarker = L.marker(position, { icon }).addTo(map);

        // Create popup content
        const popupContent = `
          <div class="p-4">
            <h3 class="font-bold text-lg mb-2">${marker.name}</h3>
            ${marker.address ? `<p class="text-gray-600 mb-2">${marker.address}</p>` : ''}
            ${marker.phone ? `<p class="text-gray-600 mb-2">${marker.phone}</p>` : ''}
            <div class="flex gap-2 mt-4">
              ${marker.phone ? `<a href="tel:${marker.phone}" class="text-green-600 hover:text-green-700 map-link">Call</a>` : ''}
              ${marker.website ? `<a href="${marker.website}" target="_blank" rel="noopener noreferrer" class="text-green-600 hover:text-green-700 map-link">Website</a>` : ''}
              <button onclick="window.openDirections(${marker.lat}, ${marker.lng})" class="text-green-600 hover:text-green-700 map-link cursor-pointer">Directions</button>
            </div>
          </div>
        `;

        leafletMarker.bindPopup(popupContent);

        // Handle marker click
        leafletMarker.on('click', () => {
          // Remove bounce from previous marker
          if (activeMarker && activeMarker !== leafletMarker) {
            const prevIcon = activeMarker.getElement();
            if (prevIcon) prevIcon.classList.remove('marker-bounce');
          }

          // Add bounce animation
          const iconElement = leafletMarker.getElement();
          if (iconElement) {
            iconElement.classList.add('marker-bounce');
            setTimeout(() => iconElement.classList.remove('marker-bounce'), 1500);
          }
          activeMarker = leafletMarker;

          // Show reset button
          if (resetButton) {
            resetButton.style.display = 'flex';
          }

          // Dispatch marker click event
          const event = new CustomEvent('markerClick', {
            detail: { centerId: marker.id }
          });
          document.dispatchEvent(event);
        });

        // Store reference
        markerRefs.set(marker.id, { marker: leafletMarker, data: marker });
      });

      // Fit bounds if multiple markers
      if (validMarkers.length > 1) {
        map.fitBounds(bounds, { padding: [50, 50] });
      }

      // Store initial state for reset
      initialBounds = bounds;
      initialCenter = map.getCenter();
      initialZoomLevel = map.getZoom();

      // Add reset button functionality
      if (resetButton) {
        resetButton.addEventListener('click', () => {
          // Close any open popups
          map.closePopup();

          // Remove bounce animation from active marker
          if (activeMarker) {
            const iconElement = activeMarker.getElement();
            if (iconElement) iconElement.classList.remove('marker-bounce');
          }

          // Reset the map view
          if (validMarkers.length > 1) {
            map.fitBounds(initialBounds, { padding: [50, 50] });
          } else {
            map.setView(initialCenter, initialZoomLevel);
          }

          // Hide the reset button
          resetButton.style.display = 'none';

          // Remove highlight from all centers
          document.querySelectorAll('[data-center-id]').forEach((el) => {
            el.classList.remove('highlight-center');
          });
        });
      }

      // Set up event listeners for center selection (from card clicks)
      setupMapListeners();

    } catch (error) {
      handleMapError(error);
    }
  }

  // Set up event listeners for map interactions
  function setupMapListeners() {
    document.addEventListener('centerSelect', (e) => {
      const markerData = markerRefs.get(e.detail.centerId);
      const resetButton = document.getElementById('resetMap');

      if (markerData) {
        const { marker } = markerData;

        // Close any existing popups
        map.closePopup();

        // Remove bounce from previous marker
        if (activeMarker && activeMarker !== marker) {
          const prevIcon = activeMarker.getElement();
          if (prevIcon) prevIcon.classList.remove('marker-bounce');
        }
        activeMarker = marker;

        // Show reset button
        if (resetButton) {
          resetButton.style.display = 'flex';
        }

        // Instantly move map (no animation) and open popup
        map.setView(marker.getLatLng(), 15, { animate: false });
        marker.openPopup();

        // Add bounce animation after a tiny delay for DOM to settle
        setTimeout(() => {
          const iconElement = marker.getElement();
          if (iconElement) {
            iconElement.classList.add('marker-bounce');
            setTimeout(() => iconElement.classList.remove('marker-bounce'), 1500);
          }
        }, 10);
      }
    });
  }

  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeMap);
  } else {
    initializeMap();
  }
</script>
